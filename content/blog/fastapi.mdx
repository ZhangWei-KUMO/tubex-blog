
---
title: åœ¨CloudFlare Workersä¸Šéƒ¨ç½²FastAPIåº”ç”¨
description:  ä»äº†è§£Pythonå¦‚ä½•åœ¨Workersä¸Šè¿è¡Œçš„æœºåˆ¶åˆ°æˆåŠŸéƒ¨ç½²ä¸€ä¸ªAPIåº”ç”¨
date: 2024-03-10
tags: ["python", "ai"]
published: true
---

<Callout type="warning">æ³¨æ„ï¼šæœ¬é¡¹ç›®è¯»è€…éœ€è¦å…·æœ‰Pythonç¼–ç¨‹çš„åŸºç¡€çŸ¥è¯†å’Œå¯¹CloudFlareæœ‰ä¸€å®šçš„ä½¿ç”¨ç»éªŒ</Callout>

ä¸åŒäºå®Œå…¨æ”¯æŒTSå’ŒJSï¼ŒCloudFlare Workerså¯¹Pythonçš„æ”¯æŒè¿˜å¤„äºbetaç‰ˆç¯èŠ‚ã€‚ç›®å‰çš„æ”¯æŒå¦‚ä¸‹ï¼š
1. å¤§å¤šæ•° Python æ ‡å‡†åº“
2. CloudFlareæœåŠ¡ç»‘å®šï¼ŒåŒ…æ‹¬ Workers AIã€Vectorizeã€R2ã€KVã€D1ã€é˜Ÿåˆ—ã€æŒä¹…å¯¹è±¡ã€æœåŠ¡ç»‘å®šç­‰.
3. ç¯å¢ƒå˜é‡å’Œå¯†é’¥æ”¯æŒ

<Callout type="warning">Python Workers å¤„äºå…¬æµ‹é˜¶æ®µã€‚
ç›®å‰æ‚¨åªèƒ½åœ¨æœ¬åœ°å¼€å‘ä¸­ä½¿ç”¨å†…ç½®åŒ…ã€‚å³å°†æ”¯æŒä½¿ç”¨`requirements.txt` æ–‡ä»¶éƒ¨ç½²åŒ…ã€‚
æ‚¨å¿…é¡»å°† `python_workers` å…¼å®¹æ€§æ ‡å¿—æ·»åŠ åˆ°æ‚¨çš„ Worker</Callout>

```py
from js import Response, Headers, fetch

async def on_fetch(request):
    endpoint = "https://api.waqi.info/feed/geo:"
    token = "" # Use a token from https://aqicn.org/api/
    html_style = "body{padding:6em; font-family: sans-serif;} h1{color:#f6821f}"
    html_content = "<h1>Weather ğŸŒ¦</h1>"

    latitude = request.cf.latitude
    longitude = request.cf.longitude

    endpoint += f"{latitude};{longitude}/?token={token}"
    response = await fetch(endpoint)
    content = await response.json()

    html_content += "<p>This is a demo using Workers geolocation data. </p>"
    html_content += f"You are located at: {latitude},{longitude}.</p>"
    html_content += f"<p>Based off sensor data from <a href='{content.data.city.url}'>{content.data.city.name}</a>:</p>"
    html_content += f"<p>The AQI level is: {content.data.aqi}.</p>"
    html_content += f"<p>The N02 level is: {content.data.iaqi.no2.v}.</p>"
    html_content += f"<p>The O3 level is: {content.data.iaqi.o3.v}.</p>"
    html_content += f"<p>The temperature is: {content.data.iaqi.t.v}Â°C.</p>"

    html = f"""
    <!DOCTYPE html>
      <head>
        <title>Geolocation: Weather</title>
      </head>
      <body>
        <style>{html_style}</style>
        <div id="container">
        {html_content}
        </div>
      </body>
    """

    headers = Headers.new({"content-type": "text/html;charset=UTF-8"}.items())
    return Response.new(html, headers=headers)
```

## FastAPI

```py
from fastapi import FastAPI, Request
from pydantic import BaseModel


async def on_fetch(request, env):
    import asgi

    return await asgi.fetch(app, request, env)


app = FastAPI()


@app.get("/")
async def root():
    return {"message": "Hello, World!"}


@app.get("/env")
async def env(req: Request):
    env = req.scope["env"]
    return {
        "message": "Here is an example of getting an environment variable: "
        + env.MESSAGE
    }


class Item(BaseModel):
    name: str
    description: str | None = None
    price: float
    tax: float | None = None


@app.post("/items/")
async def create_item(item: Item):
    return item


@app.put("/items/{item_id}")
async def update_item(item_id: int, item: Item, q: str | None = None):
    result = {"item_id": item_id, **item.model_dump()}
    if q:
        result.update({"q": q})
    return result


@app.get("/items/{item_id}")
async def read_item(item_id: int):
    return {"item_id": item_id}
```

